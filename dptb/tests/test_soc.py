import pytest
from dptb.nn.build import build_model
from dptb.postprocess.bandstructure.band import Band
import  matplotlib.pyplot  as plt
import numpy as np
from ase.io import read
from dptb.data import AtomicData, AtomicDataDict
from dptb.nn.nnsk import NNSK
import json
import torch
import os
from pathlib import Path
from dptb.entrypoints.nrl2json import nrl2json
from dptb.entrypoints.pth2json import pth2json

from dptb.utils.tools import flatten_dict


rootdir = os.path.join(Path(os.path.abspath(__file__)).parent, "data")


def test_soc_json_band():
    model = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/ckpt_soc/v2ckpt.json")
    jdata={
        "kline_type":"abacus",
        "kpath":[[0.0000000000,   0.0000000000,   0.0000000000,   2],   
                 [0.5000000000,   0.0000000000,   0.5000000000,   2],               
                 [0.6250000000,   0.2500000000,   0.6250000000,   2],    
                 [0.3750000000,   0.3750000000,   0.7500000000,   2],     
                 [0.0000000000,   0.0000000000,   0.0000000000,   2],    
                 [0.5000000000,   0.5000000000,   0.5000000000,   2],                
                 [0.5000000000,   0.2500000000,   0.7500000000,   2],               
                 [0.5000000000,   0.0000000000,   0.5000000000,   1 ]
                 ],
        "klabels":['G','X','U','K','G','L','W','X'],
        "emin":-10,
        "emax":10
    }
    # calculate the band structure
    kpath_kwargs = jdata
    bcal = Band(model=model, 
                use_gui=True, 
                results_path='./', 
                device=model.device)
    
    stru_data = f"{rootdir}/Sn/soc/dataset/Sn.vasp"    
    eigenstatus = bcal.get_bands(data=stru_data, 
                   kpath_kwargs=kpath_kwargs)

    expected_eigenvalues = np.array([[-31.007423  , -31.007412  , -20.67866   , -20.67866   ,
         -7.1311283 ,  -7.1311274 ,  -6.2365704 ,  -6.236563  ,
         -6.2365613 ,  -6.236559  ,  -4.480998  ,  -4.4809933 ,
         -3.6357822 ,  -3.6357768 ,  -3.6357756 ,  -3.635771  ,
         15.448533  ,  15.448537  ,  15.448545  ,  15.448548  ,
         18.147615  ,  18.147623  ,  18.147627  ,  18.14763   ,
         21.01311   ,  21.013113  ,  21.065922  ,  21.065931  ,
         21.065935  ,  21.065937  ,  32.408985  ,  32.409     ,
         32.412453  ,  32.412453  ,  32.41246   ,  32.412476  ],
       [-30.019188  , -30.019176  , -23.397747  , -23.397734  ,
         -8.958991  ,  -8.958984  ,  -8.785677  ,  -8.785676  ,
         -6.2776294 ,  -6.2776294 ,  -3.6961977 ,  -3.69619   ,
         -1.2760161 ,  -1.2760139 ,  -1.1798258 ,  -1.1798238 ,
         13.354958  ,  13.354959  ,  14.130192  ,  14.130194  ,
         16.96592   ,  16.965923  ,  17.039839  ,  17.03985   ,
         21.02412   ,  21.024126  ,  21.045391  ,  21.045391  ,
         24.641224  ,  24.641228  ,  29.585321  ,  29.585337  ,
         29.58534   ,  29.585346  ,  30.32741   ,  30.32742   ],
       [-27.350065  , -27.35006   , -27.350042  , -27.350033  ,
        -10.221095  , -10.221094  , -10.221093  , -10.221088  ,
         -5.289955  ,  -5.2899523 ,  -5.289951  ,  -5.28995   ,
          0.7171254 ,   0.71712595,   0.71712595,   0.7171319 ,
         14.130192  ,  14.130204  ,  14.130204  ,  14.1302185 ,
         14.374711  ,  14.374722  ,  14.374723  ,  14.374728  ,
         20.969217  ,  20.969225  ,  20.969225  ,  20.96923   ,
         26.569042  ,  26.569044  ,  26.569046  ,  26.569054  ,
         27.952032  ,  27.952042  ,  27.952045  ,  27.952055  ],
       [-27.49865   , -27.498644  , -27.19673   , -27.19673   ,
        -10.559897  , -10.55989   , -10.0144    , -10.014399  ,
         -5.4945364 ,  -5.494536  ,  -4.606873  ,  -4.606865  ,
          0.3039738 ,   0.30398044,   0.7527365 ,   0.7527418 ,
         13.917292  ,  13.917292  ,  14.088804  ,  14.088809  ,
         14.138776  ,  14.138779  ,  14.5281515 ,  14.528152  ,
         21.21819   ,  21.218195  ,  21.557903  ,  21.557907  ,
         25.775951  ,  25.775955  ,  26.720558  ,  26.72057   ,
         27.603914  ,  27.603914  ,  28.495499  ,  28.495508  ],
       [-27.919712  , -27.919712  , -26.734297  , -26.734297  ,
        -11.013819  , -11.013816  ,  -9.459296  ,  -9.459282  ,
         -5.9804435 ,  -5.980443  ,  -3.2812905 ,  -3.281289  ,
         -0.75303936,  -0.75303817,   0.8340004 ,   0.83400106,
         13.480661  ,  13.480672  ,  13.648575  ,  13.64858   ,
         14.139681  ,  14.1396885 ,  14.928459  ,  14.928464  ,
         21.759964  ,  21.759964  ,  23.02673   ,  23.026749  ,
         24.617811  ,  24.61782   ,  26.638662  ,  26.638674  ,
         27.167816  ,  27.167816  ,  29.041767  ,  29.041769  ],
       [-28.098797  , -28.098768  , -26.521578  , -26.521578  ,
        -10.925957  , -10.925954  ,  -9.719855  ,  -9.719849  ,
         -5.3289404 ,  -5.3289347 ,  -3.4857965 ,  -3.4857874 ,
         -0.8316949 ,  -0.8316835 ,   0.6037956 ,   0.60380006,
         13.456583  ,  13.456588  ,  13.499516  ,  13.49952   ,
         14.212908  ,  14.212912  ,  14.896738  ,  14.896739  ,
         22.213148  ,  22.21315   ,  23.82316   ,  23.82316   ,
         24.460823  ,  24.460823  ,  25.166416  ,  25.166416  ,
         28.172297  ,  28.17231   ,  28.86319   ,  28.8632    ],
       [-27.919712  , -27.919704  , -26.734303  , -26.7343    ,
        -11.01382   , -11.013814  ,  -9.459293  ,  -9.459288  ,
         -5.9804454 ,  -5.9804373 ,  -3.2812903 ,  -3.2812803 ,
         -0.7530421 ,  -0.7530401 ,   0.8340004 ,   0.8340021 ,
         13.480662  ,  13.480664  ,  13.648575  ,  13.648577  ,
         14.139686  ,  14.139686  ,  14.928462  ,  14.928464  ,
         21.759954  ,  21.759956  ,  23.026733  ,  23.02674   ,
         24.617813  ,  24.617823  ,  26.638664  ,  26.638676  ,
         27.167807  ,  27.167809  ,  29.041767  ,  29.041777  ],
       [-29.944735  , -29.944721  , -23.561832  , -23.561829  ,
         -9.715744  ,  -9.715741  ,  -7.5436654 ,  -7.5436587 ,
         -6.1717205 ,  -6.1717124 ,  -4.739689  ,  -4.739689  ,
         -1.834329  ,  -1.8343287 ,  -0.03966267,  -0.03966105,
         13.234669  ,  13.234671  ,  14.016897  ,  14.016902  ,
         16.121174  ,  16.121176  ,  16.95364   ,  16.953648  ,
         22.364038  ,  22.364048  ,  22.465113  ,  22.465115  ,
         23.00061   ,  23.00061   ,  29.137392  ,  29.137402  ,
         29.942379  ,  29.942392  ,  29.959831  ,  29.959839  ],
       [-31.007423  , -31.007412  , -20.67866   , -20.67866   ,
         -7.1311283 ,  -7.1311274 ,  -6.2365704 ,  -6.236563  ,
         -6.2365613 ,  -6.236559  ,  -4.480998  ,  -4.4809933 ,
         -3.6357822 ,  -3.6357768 ,  -3.6357756 ,  -3.635771  ,
         15.448533  ,  15.448537  ,  15.448545  ,  15.448548  ,
         18.147615  ,  18.147623  ,  18.147627  ,  18.14763   ,
         21.01311   ,  21.013113  ,  21.065922  ,  21.065931  ,
         21.065935  ,  21.065937  ,  32.408985  ,  32.409     ,
         32.412453  ,  32.412453  ,  32.41246   ,  32.412476  ],
       [-30.286106  , -30.2861    , -22.779444  , -22.77944   ,
         -8.85198   ,  -8.851977  ,  -7.2529488 ,  -7.2529426 ,
         -6.6678324 ,  -6.6678243 ,  -3.990609  ,  -3.990604  ,
         -3.436167  ,  -3.4361634 ,  -0.08859432,  -0.08859341,
         13.929121  ,  13.929123  ,  13.930216  ,  13.93022   ,
         17.052921  ,  17.052929  ,  17.060263  ,  17.060268  ,
         22.167538  ,  22.167542  ,  22.193502  ,  22.193504  ,
         22.477976  ,  22.477985  ,  30.144094  ,  30.144098  ,
         30.552849  ,  30.552858  ,  30.55339   ,  30.553398  ],
       [-29.173805  , -29.173784  , -25.033434  , -25.033417  ,
         -9.945103  ,  -9.945093  ,  -7.7411456 ,  -7.7411284 ,
         -7.1410484 ,  -7.141039  ,  -3.7853212 ,  -3.7853165 ,
         -3.2343507 ,  -3.23435   ,   2.390824  ,   2.390826  ,
         13.766307  ,  13.766312  ,  13.78635   ,  13.786352  ,
         14.691134  ,  14.691136  ,  14.692142  ,  14.692142  ,
         23.275118  ,  23.275133  ,  23.289207  ,  23.289211  ,
         25.757067  ,  25.757072  ,  25.949417  ,  25.949417  ,
         28.67229   ,  28.672306  ,  28.672436  ,  28.672441  ],
       [-28.684181  , -28.684177  , -25.763704  , -25.7637    ,
        -10.81131   , -10.811302  ,  -8.742746  ,  -8.742743  ,
         -6.2349133 ,  -6.2349105 ,  -3.2419832 ,  -3.2419827 ,
         -1.9287543 ,  -1.9287531 ,   1.3457793 ,   1.3457811 ,
         13.380306  ,  13.380309  ,  13.471299  ,  13.471307  ,
         14.535177  ,  14.535184  ,  15.065143  ,  15.065147  ,
         22.488743  ,  22.488745  ,  23.84412   ,  23.844122  ,
         24.985334  ,  24.985338  ,  25.403091  ,  25.403091  ,
         28.17821   ,  28.178225  ,  29.002228  ,  29.002228  ],
       [-27.351118  , -27.351114  , -27.341087  , -27.341082  ,
        -10.680595  , -10.680593  , -10.367012  , -10.367     ,
         -4.5969605 ,  -4.5969515 ,  -4.0144343 ,  -4.0144315 ,
         -0.15337452,  -0.15337159,   0.09929406,   0.09930123,
         13.607671  ,  13.607682  ,  13.630874  ,  13.630874  ,
         14.311764  ,  14.311765  ,  14.321676  ,  14.321679  ,
         22.750446  ,  22.75046   ,  22.754383  ,  22.754389  ,
         24.868992  ,  24.868992  ,  24.869698  ,  24.8697    ,
         28.487803  ,  28.487806  ,  28.497576  ,  28.497597  ],
       [-27.351591  , -27.351583  , -27.344496  , -27.344492  ,
        -10.500957  , -10.500956  , -10.2600565 , -10.260055  ,
         -5.015775  ,  -5.0157743 ,  -4.6251984 ,  -4.625198  ,
          0.30658934,   0.3065895 ,   0.4448485 ,   0.44485575,
         13.87227   ,  13.872274  ,  13.888172  ,  13.888175  ,
         14.319462  ,  14.319463  ,  14.325819  ,  14.325821  ,
         21.738235  ,  21.738243  ,  21.74036   ,  21.74037   ,
         25.797703  ,  25.797709  ,  25.79885   ,  25.798855  ,
         28.278435  ,  28.278444  ,  28.286423  ,  28.286427  ],
       [-27.350065  , -27.35006   , -27.350042  , -27.350033  ,
        -10.221095  , -10.221094  , -10.221093  , -10.221088  ,
         -5.289955  ,  -5.2899523 ,  -5.289951  ,  -5.28995   ,
          0.7171254 ,   0.71712595,   0.71712595,   0.7171319 ,
         14.130192  ,  14.130204  ,  14.130204  ,  14.1302185 ,
         14.374711  ,  14.374722  ,  14.374723  ,  14.374728  ,
         20.969217  ,  20.969225  ,  20.969225  ,  20.96923   ,
         26.569042  ,  26.569044  ,  26.569046  ,  26.569054  ,
         27.952032  ,  27.952042  ,  27.952045  ,  27.952055  ]],
        dtype=np.float32)
        
    
    assert np.allclose(eigenstatus["eigenvalues"], expected_eigenvalues, atol=1e-4)

@pytest.mark.order(3)
def test_nrl_train_freeze():
    model = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/ckpt_nsoc/v2ckpt.json")
    model_nfz = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/output/test_nsoc_v2json/checkpoint/nnsk.best.pth")
    model_fz = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/output/test_nsoc_v2jsonfz/checkpoint/nnsk.best.pth")

    assert torch.any(torch.abs(model_nfz.hopping_param - model.hopping_param ) > 1e-5)
    assert torch.any(torch.abs(model_nfz.strain_param  - model.strain_param )> 1e-5)
    #assert torch.any(torch.abs(model_nfz.soc_param - model.soc_param )> 1e-5)

    assert torch.all(torch.abs(model_fz.hopping_param - model.hopping_param ) < 1e-5)
    assert torch.all(torch.abs(model_fz.strain_param - model.strain_param ) < 1e-6)
    #assert torch.any(torch.abs(model_fz.soc_param - model.soc_param ) > 1e-5)

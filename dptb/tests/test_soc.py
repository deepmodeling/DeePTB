import pytest
from dptb.nn.build import build_model
from dptb.postprocess.bandstructure.band import Band
import  matplotlib.pyplot  as plt
import numpy as np
from ase.io import read
from dptb.data import AtomicData, AtomicDataDict
from dptb.nn.nnsk import NNSK
import json
import torch
import os
from pathlib import Path
from dptb.entrypoints.nrl2json import nrl2json
from dptb.entrypoints.pth2json import pth2json

from dptb.utils.tools import flatten_dict


rootdir = os.path.join(Path(os.path.abspath(__file__)).parent, "data")


def test_soc_json_band():
    model = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/ckpt_soc/v2ckpt.json")
    jdata={
        "kline_type":"abacus",
        "kpath":[[0.0000000000,   0.0000000000,   0.0000000000,   2],   
                 [0.5000000000,   0.0000000000,   0.5000000000,   2],               
                 [0.6250000000,   0.2500000000,   0.6250000000,   2],    
                 [0.3750000000,   0.3750000000,   0.7500000000,   2],     
                 [0.0000000000,   0.0000000000,   0.0000000000,   2],    
                 [0.5000000000,   0.5000000000,   0.5000000000,   2],                
                 [0.5000000000,   0.2500000000,   0.7500000000,   2],               
                 [0.5000000000,   0.0000000000,   0.5000000000,   1 ]
                 ],
        "klabels":['G','X','U','K','G','L','W','X'],
        "emin":-10,
        "emax":10
    }
    # calculate the band structure
    kpath_kwargs = jdata
    bcal = Band(model=model, 
                use_gui=True, 
                results_path='./', 
                device=model.device)
    
    stru_data = f"{rootdir}/Sn/soc/dataset/Sn.vasp"
    AtomicData_options = {"r_max": 6.0, "oer_max":3.0, "pbc": True}
    
    eigenstatus = bcal.get_bands(data=stru_data, 
                   kpath_kwargs=kpath_kwargs, 
                   AtomicData_options=AtomicData_options)

    expected_eigenvalues = np.array([[-18.796585  , -18.796577  ,  -8.796718  ,  -8.796717  ,
         -8.467822  ,  -8.46782   ,  -8.202273  ,  -8.202273  ,
         -8.202272  ,  -8.202268  ,  -6.520131  ,  -6.5201283 ,
         -5.6209826 ,  -5.6209826 ,  -5.6209803 ,  -5.620978  ,
          1.1558133 ,   1.1558162 ,   1.1558177 ,   1.1558225 ,
          3.8549075 ,   3.8549078 ,   3.8549087 ,   3.8549109 ,
         10.136021  ,  10.136023  ,  10.439617  ,  10.439617  ,
         10.439621  ,  10.439622  ,  16.604067  ,  16.60407   ,
         16.604074  ,  16.604078  ,  16.60518   ,  16.60518   ],
       [-17.965763  , -17.965757  , -12.480173  , -12.480173  ,
        -10.082873  , -10.082871  , -10.001692  , -10.001686  ,
         -6.423237  ,  -6.423237  ,  -5.713276  ,  -5.713276  ,
         -3.4990137 ,  -3.4990127 ,  -3.2606316 ,  -3.260627  ,
         -1.2786437 ,  -1.278643  ,  -0.16114095,  -0.16113918,
          2.7485087 ,   2.7485092 ,   2.9157577 ,   2.9157612 ,
          9.215347  ,   9.215352  ,   9.373201  ,   9.373207  ,
         13.123983  ,  13.123989  ,  14.268081  ,  14.268081  ,
         14.278081  ,  14.278091  ,  15.152899  ,  15.1529045 ],
       [-15.753845  , -15.753845  , -15.753841  , -15.753836  ,
        -11.016632  , -11.016631  , -11.016631  , -11.01663   ,
         -6.9324965 ,  -6.932495  ,  -6.932495  ,  -6.9324923 ,
         -0.52784276,  -0.52784216,  -0.52783954,  -0.5278391 ,
          0.07181728,   0.07181839,   0.07181882,   0.07181931,
          0.08202878,   0.08202914,   0.08203014,   0.08203081,
          6.5781436 ,   6.5781474 ,   6.5781474 ,   6.578152  ,
         12.591245  ,  12.591249  ,  12.591251  ,  12.591253  ,
         14.805855  ,  14.805855  ,  14.805863  ,  14.805869  ],
       [-15.858617  , -15.858613  , -15.649114  , -15.64911   ,
        -11.349122  , -11.34912   , -10.8918085 , -10.891806  ,
         -6.870063  ,  -6.8700614 ,  -6.157268  ,  -6.1572657 ,
         -1.2535331 ,  -1.253531  ,  -1.0800866 ,  -1.0800853 ,
         -0.28412414,  -0.28412127,  -0.22913142,  -0.2291308 ,
          0.43651295,   0.43651417,   0.61508846,   0.6150922 ,
          6.995065  ,   6.995071  ,   7.036594  ,   7.0365944 ,
         11.637238  ,  11.637241  ,  12.705406  ,  12.705407  ,
         14.5028715 ,  14.502877  ,  15.520835  ,  15.520839  ],
       [-16.183804  , -16.183802  , -15.329778  , -15.329772  ,
        -11.730029  , -11.730025  , -10.597874  , -10.597873  ,
         -6.6675787 ,  -6.667575  ,  -4.5243273 ,  -4.524324  ,
         -2.293503  ,  -2.2935014 ,  -1.9981623 ,  -1.9981592 ,
         -1.0307596 ,  -1.0307531 ,  -0.8473131 ,  -0.847308  ,
          0.8623935 ,   0.86239386,   1.1516515 ,   1.1516529 ,
          7.940049  ,   7.9400563 ,   8.233609  ,   8.23361   ,
         10.271218  ,  10.27122   ,  13.005727  ,  13.00573   ,
         13.675878  ,  13.675881  ,  16.305794  ,  16.3058    ],
       [-16.336843  , -16.336843  , -15.167489  , -15.167487  ,
        -11.641985  , -11.641981  , -10.840412  , -10.840409  ,
         -5.5028615 ,  -5.502861  ,  -4.4378824 ,  -4.437881  ,
         -3.1876206 ,  -3.1876204 ,  -2.8593407 ,  -2.8593404 ,
         -1.0223196 ,  -1.0223194 ,  -0.03593016,  -0.0359299 ,
          0.5331634 ,   0.53316516,   1.094498  ,   1.0945    ,
          8.331565  ,   8.331567  ,   9.181907  ,   9.181908  ,
         10.318527  ,  10.31853   ,  11.164237  ,  11.16424   ,
         14.783967  ,  14.783967  ,  16.183851  ,  16.18386   ],
       [-16.183802  , -16.183798  , -15.329779  , -15.329777  ,
        -11.730029  , -11.730021  , -10.597873  , -10.59787   ,
         -6.6675773 ,  -6.6675754 ,  -4.5243297 ,  -4.524327  ,
         -2.2935047 ,  -2.2935045 ,  -1.9981617 ,  -1.9981614 ,
         -1.0307611 ,  -1.0307586 ,  -0.84731257,  -0.8473123 ,
          0.86239225,   0.862393  ,   1.1516463 ,   1.1516486 ,
          7.9400487 ,   7.9400496 ,   8.23361   ,   8.233611  ,
         10.27122   ,  10.271224  ,  13.005723  ,  13.005732  ,
         13.675874  ,  13.675881  ,  16.305796  ,  16.305796  ],
       [-17.900473  , -17.900473  , -12.844977  , -12.844976  ,
        -10.530397  , -10.530396  ,  -9.09718   ,  -9.097178  ,
         -6.7394004 ,  -6.739399  ,  -4.928301  ,  -4.9282985 ,
         -4.1416554 ,  -4.1416535 ,  -3.2446477 ,  -3.2446465 ,
         -1.2467662 ,  -1.2467624 ,  -0.16752447,  -0.1675212 ,
          2.0890796 ,   2.0890806 ,   2.8771484 ,   2.87715   ,
         10.350287  ,  10.350292  ,  10.554118  ,  10.554125  ,
         10.833848  ,  10.833856  ,  13.666271  ,  13.666271  ,
         14.696394  ,  14.696395  ,  15.524468  ,  15.524472  ],
       [-18.796585  , -18.796577  ,  -8.796718  ,  -8.796717  ,
         -8.467822  ,  -8.46782   ,  -8.202273  ,  -8.202273  ,
         -8.202272  ,  -8.202268  ,  -6.520131  ,  -6.5201283 ,
         -5.6209826 ,  -5.6209826 ,  -5.6209803 ,  -5.620978  ,
          1.1558133 ,   1.1558162 ,   1.1558177 ,   1.1558225 ,
          3.8549075 ,   3.8549078 ,   3.8549087 ,   3.8549109 ,
         10.136021  ,  10.136023  ,  10.439617  ,  10.439617  ,
         10.439621  ,  10.439622  ,  16.604067  ,  16.60407   ,
         16.604074  ,  16.604078  ,  16.60518   ,  16.60518   ],
       [-18.186668  , -18.186663  , -12.287521  , -12.287515  ,
         -9.351741  ,  -9.351739  ,  -8.878574  ,  -8.878569  ,
         -7.6058683 ,  -7.6058674 ,  -5.154534  ,  -5.154529  ,
         -4.6624527 ,  -4.662451  ,  -3.4278681 ,  -3.427864  ,
         -0.41998848,  -0.41998297,  -0.4095187 ,  -0.40951777,
          2.9563828 ,   2.9563835 ,   2.9918096 ,   2.9918125 ,
         10.380918  ,  10.380918  ,  10.549788  ,  10.549789  ,
         11.232219  ,  11.232219  ,  14.940169  ,  14.940175  ,
         15.070571  ,  15.070571  ,  15.075499  ,  15.0755005 ],
       [-17.198385  , -17.19838   , -14.515316  , -14.515307  ,
         -9.862983  ,  -9.862981  ,  -9.357086  ,  -9.357084  ,
         -8.073727  ,  -8.073721  ,  -4.8036227 ,  -4.8036175 ,
         -4.4337177 ,  -4.4337125 ,  -1.1210939 ,  -1.1210878 ,
          0.15520462,   0.15520588,   0.16363804,   0.16363822,
          0.24147274,   0.24147661,   0.41342714,   0.41343114,
         10.37974   ,  10.379746  ,  10.456181  ,  10.456185  ,
         10.552433  ,  10.552438  ,  13.742164  ,  13.742164  ,
         13.763256  ,  13.763256  ,  14.501388  ,  14.501396  ],
       [-16.80349   , -16.803486  , -14.751759  , -14.751757  ,
        -11.285735  , -11.285734  , -10.22461   , -10.224609  ,
         -6.24789   ,  -6.24789   ,  -4.6060047 ,  -4.6060038 ,
         -3.434149  ,  -3.4341471 ,  -2.2420568 ,  -2.2420552 ,
         -1.0955485 ,  -1.0955476 ,  -0.19254336,  -0.19254316,
          0.6856604 ,   0.68566144,   1.1567098 ,   1.1567105 ,
          9.163708  ,   9.16371   ,   9.635809  ,   9.635814  ,
         10.698371  ,  10.698381  ,  11.82481   ,  11.82481   ,
         13.985387  ,  13.985389  ,  16.133114  ,  16.133121  ],
       [-15.776018  , -15.776018  , -15.7288265 , -15.728823  ,
        -11.566163  , -11.566163  , -11.256174  , -11.256172  ,
         -4.9769745 ,  -4.9769716 ,  -4.5070167 ,  -4.5070157 ,
         -3.389411  ,  -3.3894083 ,  -3.2984304 ,  -3.2984302 ,
          0.10734507,   0.10734744,   0.17103618,   0.17103752,
          0.26678348,   0.26678437,   0.40296242,   0.40296602,
          8.415588  ,   8.415589  ,   8.428018  ,   8.428018  ,
         10.579563  ,  10.579564  ,  10.626951  ,  10.626951  ,
         15.609341  ,  15.6093445 ,  15.68799   ,  15.688002  ],
       [-15.769385  , -15.769385  , -15.736303  , -15.736301  ,
        -11.354855  , -11.354855  , -11.111078  , -11.111077  ,
         -6.22072   ,  -6.2207155 ,  -5.98496   ,  -5.9849544 ,
         -1.8360822 ,  -1.8360817 ,  -1.750961  ,  -1.7509596 ,
          0.07467235,   0.07467385,   0.08895914,   0.0889603 ,
          0.30550689,   0.30550796,   0.39796725,   0.39797014,
          7.371509  ,   7.371511  ,   7.3771377 ,   7.377142  ,
         11.648639  ,  11.648641  ,  11.689653  ,  11.689657  ,
         15.269731  ,  15.269734  ,  15.337125  ,  15.3371315 ],
       [-15.753845  , -15.753845  , -15.753841  , -15.753836  ,
        -11.016632  , -11.016631  , -11.016631  , -11.01663   ,
         -6.9324965 ,  -6.932495  ,  -6.932495  ,  -6.9324923 ,
         -0.52784276,  -0.52784216,  -0.52783954,  -0.5278391 ,
          0.07181728,   0.07181839,   0.07181882,   0.07181931,
          0.08202878,   0.08202914,   0.08203014,   0.08203081,
          6.5781436 ,   6.5781474 ,   6.5781474 ,   6.578152  ,
         12.591245  ,  12.591249  ,  12.591251  ,  12.591253  ,
         14.805855  ,  14.805855  ,  14.805863  ,  14.805869  ]])
    
    assert np.allclose(eigenstatus["eigenvalues"], expected_eigenvalues, atol=1e-4)

@pytest.mark.order(3)
def test_nrl_train_freeze():
    model = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/ckpt_nsoc/v2ckpt.json")
    model_nfz = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/output/test_nsoc_v2json/checkpoint/nnsk.best.pth")
    model_fz = NNSK.from_reference(checkpoint= f"{rootdir}/Sn/soc/output/test_nsoc_v2jsonfz/checkpoint/nnsk.best.pth")

    assert torch.any(torch.abs(model_nfz.hopping_param - model.hopping_param ) > 1e-5)
    assert torch.any(torch.abs(model_nfz.strain_param  - model.strain_param )> 1e-5)
    #assert torch.any(torch.abs(model_nfz.soc_param - model.soc_param )> 1e-5)

    assert torch.all(torch.abs(model_fz.hopping_param - model.hopping_param ) < 1e-5)
    assert torch.all(torch.abs(model_fz.strain_param - model.strain_param ) < 1e-6)
    #assert torch.any(torch.abs(model_fz.soc_param - model.soc_param ) > 1e-5)
